<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:json="http://www.mulesoft.org/schema/mule/json"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/json http://www.mulesoft.org/schema/mule/json/current/mule-json.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="validateAndTransformSubFlow" doc:id="c17c15f0-f054-4557-9ad3-290e04c8b052" >
		<set-payload value='#[output application/json&#10;---&#10;read(payload.msg.value, "application/json")]' doc:name="Set Payload" doc:id="2208d484-92e2-45d3-bbb5-a77d7d16b538" />
		<try doc:name="Try" doc:id="2182a498-e8dd-4e73-a6f7-63c0e989d24c" >
			<json:validate-schema doc:name="Validate schema" doc:id="bf620cda-fa93-4093-93a0-86b7d8b5be0a" schema="schemas/msg-schema.json" />
			<set-payload value="#[output application/json&#10;---&#10;{&#10;	'paymensCurrency': payload.paymens.currency,&#10;	'paymensId': payload.paymens.paymensId,&#10;	'paymensTime': payload.paymens.paymensTime,&#10;    'items': payload.items map ((item) -&gt; {&#10;        'name': item.name,&#10;        'count': item.count,&#10;        'id': item.id,&#10;        'price': item.price * item.count,&#10;        'warehouseId': payload.address.pvzId&#10;	})&#10;}]" doc:name="Transform Payload" />
			<error-handler >
				<on-error-continue enableNotifications="true" logException="false" doc:name="On Error Continue" doc:id="4e0e86ff-ed99-4c85-ba3c-e0f1e603036f" >
					<logger level="ERROR" doc:name="[ERROR] Invalid item" doc:id="f7812b06-493c-40b5-bb60-a4bc8dcba4c8" message="Error: #[error.errorMessage.payload.message]" />
					<set-payload value="#[null]" doc:name="Set null" doc:id="770c38fc-84a2-442e-b0c8-7a234a034480" />
				</on-error-continue>
			</error-handler>
		</try>
	</sub-flow>
</mule>

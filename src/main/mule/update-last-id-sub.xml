<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">
	<sub-flow name="updateLastProcessedIdSubFlow" doc:id="c2d69b1b-98f5-410c-9231-26f770bba749" >
		<choice doc:name="Choice" doc:id="47ed6112-7d01-4a06-861c-d9dd57e2c385" >
			<when expression="#[payload.lastProcessedId == null]">
				<db:insert doc:name="Insert" doc:id="29e44245-fb47-4510-b521-9a36591b0809" config-ref="Postgres_ESB_Config">
					<db:sql ><![CDATA[INSERT INTO esb_obj_commit.cursor (name, value, created_at, updated_at) 
VALUES ('last-message-id', :msg_id, :created_at, :updated_at);]]></db:sql>
					<db:input-parameters ><![CDATA[#[{
	"msg_id": payload.messageId,
	"created_at": now() as String {format: "yyyy-MM-dd HH:mm:ssXXX"},
	"updated_at": now() as String {format: "yyyy-MM-dd HH:mm:ssXXX"}
}]]]></db:input-parameters>
				</db:insert>
			</when>
			<otherwise >
				<db:update doc:name="Update" doc:id="4c05d04e-cd9f-422d-a5e1-62c6619644c9" config-ref="Postgres_ESB_Config">
					<db:sql ><![CDATA[UPDATE esb_obj_commit.cursor 
SET value = :msg_id, updated_at = :updated_at 
WHERE name = 'last-message-id']]></db:sql>
					<db:input-parameters ><![CDATA[#[{
	"msg_id": payload.messageId,
	"updated_at": now() as String {format: "yyyy-MM-dd HH:mm:ssXXX"}
}]]]></db:input-parameters>
				</db:update>
			</otherwise>
		</choice>
	</sub-flow>
</mule>
